{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>{{ restaurante.nombre }} | TopMeal</title>
    <link rel="stylesheet" href="{% static 'css/base/restaurante_detail.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="icon" href="{% static 'img/base/logo.png' %}" type="image/x-icon">
    <style>
        body {
            /* Fondo: gradiente muy sutil de blanco a blanco grisáceo */
            background: linear-gradient(180deg, #ccb893 0%, #f3f3f3 100%);
        }
    </style>
</head>
<body>
    <!-- Sticky Navbar -->
    <nav class="navbar">
        <div class="navbar-logo">
            <img src="{% static 'img/base/logo.png' %}" alt="TopMeal Logo">
            <a href="{% url 'inicio' %}">
                <span>TopMeal</span>
            </a>
        </div>
        <div class="navbar-actions">
            {% if usuario_nombre %}
                <div style="display:flex;align-items:center;gap:14px;">
                    <span style="font-weight:600;padding:7px 18px;background:#f5e8d3;color:#e63946;border-radius:20px;font-size:1em;box-shadow:0 1px 6px #0001;display:flex;align-items:center;">
                        <span style="vertical-align:middle;">{{ usuario_nombre }}</span>
                    </span>
                    <a href="{% url 'logout' %}" class="btn-outline" style="background:#e63946;color:#fff;border:none;">Cerrar sesión</a>
                </div>
            {% else %}
                <a href="{% url 'register' %}" class="btn-outline">Registrarse</a>
                <a href="{% url 'login' %}" class="btn-primary">Iniciar Sesión</a>
            {% endif %}
        </div>
    </nav>
    <main>
        <!-- Restaurant Header -->
        <section class="restaurant-card">
            <div class="restaurant-info" style="display: flex; flex-direction: row; align-items: stretch; gap: 32px; width: 100%;">
                <div style="flex: 2; display: flex; flex-direction: column; justify-content: space-between;">
                    <h2>{{ restaurante.nombre }}</h2>
                    <div class="restaurant-details">
                        <div class="restaurant-detail">
                            <!-- Icono calendario para dirección -->
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <rect x="3" y="4" width="18" height="18" rx="4" fill="none" stroke-width="2"/>
                                <path d="M16 2v4M8 2v4M3 10h18" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                            {{ restaurante.direccion }}
                        </div>
                        <div class="restaurant-detail">
                            <!-- Icono comida -->
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M3 12h18M4 15h16M2 18h20" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <circle cx="12" cy="8" r="2" stroke-width="2" />
                            </svg>
                            {{ restaurante.tipo }}{% if restaurante.precio_medio %} - Precio medio: {{ restaurante.precio_medio }} €{% endif %}
                        </div>
                        <div class="restaurant-detail">
                            <!-- Icono estrella -->
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.518 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.977 2.89a1 1 0 00-.364 1.118l1.518 4.674c.3.921-.755 1.688-1.54 1.118l-3.977-2.89a1 1 0 00-1.176 0l-3.977 2.89c-.784.57-1.838-.197-1.54-1.118l1.518-4.674a1 1 0 00-.364-1.118L2.978 10.1c-.783-.57-.38-1.81.588-1.81h4.915a1 1 0 00.95-.69l1.518-4.674z" />
                            </svg>
                            <span class="rating">{{ restaurante.media_valoracion|default:"-" }}</span>
                            {% if restaurante.num_opiniones %}
                                ({{ restaurante.num_opiniones }} opiniones)
                            {% endif %}
                        </div>
                    </div>
                    <div class="actions">
                        <button class="rate-button" aria-label="Valorar restaurante">Valorar</button>
                    </div>
                </div>
                <div class="restaurant-image" style="flex:1;display:flex;align-items:center;justify-content:center;">
                    <img src="{{ restaurante.imagen_url }}" alt="Imagen principal de {{ restaurante.nombre }}" style="max-width:100%; width:100%; height:90%; max-height:420px; object-fit:cover; border-radius:18px; box-shadow:0 4px 18px #e6394610;">
                </div>
            </div>
        </section>

        <!-- Menu and Reservation Section -->
        <section class="restaurant-content">
            <div class="container">
                <!-- Menu Section -->
                <div class="restaurant-main">
                    <h2>Carta</h2>
                    <div class="menu-section">
                        <img src="{{ menu.imagen_url }}" alt="Menú del restaurante">
                        <a class="btn-primary" aria-label="Pedir a domicilio" href="#">Pedir a domicilio</a>
                    </div>

                    <!-- Opinions Section -->
                    <br>
                    <br>
                    
                    <div class="opiniones-section">
                        <h2>Opiniones</h2>
                        <div class="opinion-summary">
                            <div class="opinion-left">
                                <p class="rating-overview">{{ restaurante.media_valoracion|default:"-" }} <span style="color: green;">Excelente</span></p>
                                <p>{{ restaurante.num_opiniones|default:"0" }} opiniones</p>
                            </div>
                            <div class="opinion-right">
                                <div>
                                    <p>Ambiente</p>
                                    <div class="rating-bar-container">
                                        <div class="rating-bar" style="width: 94%; --score: 9.4;"></div>
                                        <span class="rating-bar-label">9.4</span>
                                    </div>
                                </div>
                                <div>
                                    <p>Comida</p>
                                    <div class="rating-bar-container">
                                        <div class="rating-bar" style="width: 85%; --score: 8.5;"></div>
                                        <span class="rating-bar-label">8.5</span>
                                    </div>
                                </div>
                                <div>
                                    <p>Servicio</p>
                                    <div class="rating-bar-container">
                                        <div class="rating-bar" style="width: 88%; --score: 8.8;"></div>
                                        <span class="rating-bar-label">8.8</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reservation Section -->
                <div class="restaurant-aside">
                    <h2>Reservar</h2>
                    <div class="reservation-section">
                        <div class="calendar-header" style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                            <button class="prev-month" aria-label="Mes anterior" id="prevMonthBtn"
                                style="background: #e63946;
                                       color: #fff;
                                       border: none;
                                       border-radius: 0;
                                       width: 28px;
                                       height: 28px;
                                       font-size: 1.1em;
                                       box-shadow: none;
                                       cursor: pointer;
                                       display: flex;
                                       align-items: center;
                                       justify-content: center;
                                       outline: none;
                                       transition: background 0.2s;
                                "
                                onmouseover="this.style.background='#b92d3a';"
                                onmouseout="this.style.background='#e63946';"
                            >&#9664;</button>
                            <span class="calendar-title" id="calendarTitle" style="font-weight:bold; min-width:120px; text-align:center;"></span>
                            <button class="next-month" aria-label="Mes siguiente" id="nextMonthBtn"
                                style="background: #e63946;
                                       color: #fff;
                                       border: none;
                                       border-radius: 0;
                                       width: 28px;
                                       height: 28px;
                                       font-size: 1.1em;
                                       box-shadow: none;
                                       cursor: pointer;
                                       display: flex;
                                       align-items: center;
                                       justify-content: center;
                                       outline: none;
                                       transition: background 0.2s;
                                "
                                onmouseover="this.style.background='#b92d3a';"
                                onmouseout="this.style.background='#e63946';"
                            >&#9654;</button>
                        </div>
                        <div class="calendar" id="calendarDays">
                            <!-- Los días se generan por JS -->
                        </div>
                        <label for="horaReserva">Hora</label>
                        <select id="horaReserva">
                            <option value="13:00">13:00</option>
                            <option value="13:30">13:30</option>
                            <option value="14:00">14:00</option>
                            <option value="14:30">14:30</option>
                            <option value="15:00">15:00</option>
                            <option value="21:00">21:00</option>
                            <option value="21:30">21:30</option>
                            <option value="22:00">22:00</option>
                        </select>
                        <label for="personasReserva">Personas</label>
                        <select id="personasReserva">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                            <option value="13">13</option>
                            <option value="14">14</option>
                            <option value="15">15</option>
                            <option value="16">16</option>
                            <option value="17">17</option>
                            <option value="18">18</option>
                        </select>
                        <button class="btn-primary" id="btnReservar" aria-label="Confirmar reserva">Reservar</button>
                        <div id="reserva-msg" style="display:none; margin-top:10px;"></div>
                    </div>
                </div>
            </div>
        </section>
    </main>
    <!-- Footer -->
    <footer class="footer" id="contacto" style="background: #222; color: #fff; padding: 36px 0 0 0; margin-top: 0;">
        <div class="footer-main" style="display: flex; flex-wrap: wrap; justify-content: space-between; align-items: flex-start; max-width: 1100px; margin: 0 auto; padding: 0 24px; gap: 32px;">
            <div class="footer-logo" style="display: flex; align-items: center; gap: 10px; font-size: 1.3em; font-weight: bold; color: #e63946;">
                <img src="{% static 'img/base/logo.png' %}" alt="TopMeal Logo" style="height: 34px;">
                <span>TopMeal</span>
            </div>
            <div class="footer-links" style="display: flex; gap: 38px;">
                <div style="display: flex; flex-direction: column; gap: 6px;">
                    <h5 style="color: #e9c46a; font-size: 1.05em; margin-bottom: 4px;">Colabora</h5>
                    <a href="#" style="color: #fff; font-size: 0.98em; opacity: 0.85; transition: opacity 0.18s;">Repartidores</a>
                    <a href="#" style="color: #fff; font-size: 0.98em; opacity: 0.85; transition: opacity 0.18s;">Trabaja con nosotros</a>
                    <a href="#" style="color: #fff; font-size: 0.98em; opacity: 0.85; transition: opacity 0.18s;">Añade tu restaurante</a>
                </div>
                <div style="display: flex; flex-direction: column; gap: 6px;">
                    <h5 style="color: #e9c46a; font-size: 1.05em; margin-bottom: 4px;">Enlaces</h5>
                    <a href="{% url 'acerca' %}" style="color: #fff; font-size: 0.98em; opacity: 0.85; transition: opacity 0.18s;">Acerca de nosotros</a>
                    <a href="{% url 'contacto' %}" style="color: #fff; font-size: 0.98em; opacity: 0.85; transition: opacity 0.18s;">Contacto</a>
                    <!-- <a href="#">Seguridad</a> -->
                </div> 
                <div style="display: flex; flex-direction: column; gap: 6px;">
                    <h5 style="color: #e9c46a; font-size: 1.05em; margin-bottom: 4px;">Legal</h5>
                    <a href="{% url 'legales' %}" style="color: #fff; font-size: 0.98em; opacity: 0.85; transition: opacity 0.18s;">Cookies</a>
                    <a href="{% url 'legales' %}" style="color: #fff; font-size: 0.98em; opacity: 0.85; transition: opacity 0.18s;">Condiciones de uso</a>
                    <a href="{% url 'legales' %}" style="color: #fff; font-size: 0.98em; opacity: 0.85; transition: opacity 0.18s;">Privacidad</a>
                </div>
            </div>
            <div class="footer-social" style="background: #222; border-radius: 12px; padding: 18px 0; display: flex; justify-content: center; gap: 18px;">
                <a href="#"><img src="https://img.icons8.com/color/48/000000/facebook-new.png" alt="Facebook" style="width: 32px; height: 32px; object-fit: contain; border-radius: 8px; background: #fff; box-shadow: 0 1px 4px rgba(0,0,0,0.07);"></a>
                <a href="#"><img src="https://img.icons8.com/color/48/000000/instagram-new.png" alt="Instagram" style="width: 32px; height: 32px; object-fit: contain; border-radius: 8px; background: #fff; box-shadow: 0 1px 4px rgba(0,0,0,0.07);"></a>
                <a href="#"><img src="https://img.icons8.com/color/48/000000/twitterx--v2.png" alt="X" style="width: 32px; height: 32px; object-fit: contain; border-radius: 8px; background: #fff; box-shadow: 0 1px 4px rgba(0,0,0,0.07);"></a>
            </div>
        </div>
        <div class="footer-copy" style="text-align: center; color: #bbb; font-size: 0.98em; margin-top: 18px; padding-bottom: 18px;">
            &copy; 2025 TopMeal. Todos los derechos reservados.
        </div>
    </footer>
</body>
</html>
<script>
    // Generador de calendario interactivo SOLO para el mes actual
    document.addEventListener('DOMContentLoaded', function() {
        const calendarTitle = document.getElementById('calendarTitle');
        const calendarDays = document.getElementById('calendarDays');
        const nextMonthBtn = document.getElementById('nextMonthBtn');
        const prevMonthBtn = document.getElementById('prevMonthBtn');
        window.selectedDate = null;

        let today = new Date();
        let currentMonth = today.getMonth();
        let currentYear = today.getFullYear();

        function renderCalendar(month, year) {
            calendarDays.innerHTML = '';
            // Cabecera días de la semana
            const daysOfWeek = ['lun', 'mar', 'mié', 'jue', 'vie', 'sáb', 'dom'];
            daysOfWeek.forEach(d => {
                const span = document.createElement('span');
                span.className = 'day-header';
                span.textContent = d;
                calendarDays.appendChild(span);
            });

            // Primer día del mes (0=domingo, 1=lunes...)
            const firstDay = new Date(year, month, 1);
            let startDay = firstDay.getDay();
            startDay = startDay === 0 ? 7 : startDay; // Domingo al final

            // Días vacíos antes del 1
            for (let i = 1; i < startDay; i++) {
                calendarDays.appendChild(document.createElement('span'));
            }

            // Días del mes
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let d = 1; d <= daysInMonth; d++) {
                const dateObj = new Date(year, month, d);
                const span = document.createElement('span');
                span.className = 'day';
                span.textContent = d;

                // No permitir seleccionar días anteriores a hoy
                if (
                    (year < today.getFullYear()) ||
                    (year === today.getFullYear() && month < today.getMonth()) ||
                    (year === today.getFullYear() && month === today.getMonth() && d < today.getDate())
                ) {
                    span.classList.add('disabled');
                } else {
                    span.addEventListener('click', function() {
                        // Deseleccionar anterior
                        calendarDays.querySelectorAll('.day.selected').forEach(el => el.classList.remove('selected'));
                        span.classList.add('selected');
                        window.selectedDate = new Date(year, month, d);
                    });
                }
                calendarDays.appendChild(span);
            }
        }

        function updateCalendarTitle(month, year) {
            const meses = [
                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
            ];
            calendarTitle.innerHTML = `<b>${meses[month]} de ${year}</b>`;
        }

        // Inicializar calendario
        updateCalendarTitle(currentMonth, currentYear);
        renderCalendar(currentMonth, currentYear);

        // Permitir avanzar meses
        nextMonthBtn.addEventListener('click', function() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            updateCalendarTitle(currentMonth, currentYear);
            renderCalendar(currentMonth, currentYear);
        });

        // Permitir retroceder meses, pero no antes del mes/año actual
        prevMonthBtn.addEventListener('click', function() {
            if (currentYear > today.getFullYear() || (currentYear === today.getFullYear() && currentMonth > today.getMonth())) {
                currentMonth--;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                }
                updateCalendarTitle(currentMonth, currentYear);
                renderCalendar(currentMonth, currentYear);
            }
        });

        // Utilidad para formatear la fecha seleccionada
        function getFechaSeleccionada() {
            if (!selectedDate) return null;
            const y = selectedDate.getFullYear();
            const m = String(selectedDate.getMonth() + 1).padStart(2, '0');
            const d = String(selectedDate.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        // Corrige el uso de selectedDate en el botón reservar
        document.getElementById('btnReservar').addEventListener('click', function() {
            // Usa la función getFechaSeleccionada para comprobar la fecha
            const fecha = getFechaSeleccionada();
            if (!fecha) {
                if (document.getElementById('reserva-msg')) {
                    document.getElementById('reserva-msg').style.display = 'block';
                    document.getElementById('reserva-msg').style.color = 'red';
                    document.getElementById('reserva-msg').textContent = 'Selecciona una fecha válida para la reserva.';
                }
                return;
            }
            const hora = document.getElementById('horaReserva').value;
            const personas = document.getElementById('personasReserva').value;
            fetch("{% url 'api_reservar' restaurante.id %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({
                    fecha: fecha,
                    hora: hora,
                    numero_personas: personas
                })
            })
            .then(resp => resp.json())
            .then(data => {
                if (data.success) {
                    if (document.getElementById('reserva-msg')) {
                        document.getElementById('reserva-msg').style.display = 'block';
                        document.getElementById('reserva-msg').style.color = 'green';
                        document.getElementById('reserva-msg').textContent = '¡Reserva realizada correctamente!';
                    }
                } else {
                    if (document.getElementById('reserva-msg')) {
                        document.getElementById('reserva-msg').style.display = 'block';
                        document.getElementById('reserva-msg').style.color = 'red';
                        document.getElementById('reserva-msg').textContent = data.error || 'Error al reservar';
                    }
                }
            });
        });
    });
</script>
